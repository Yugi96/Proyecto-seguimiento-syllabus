{% extends 'base/base.app.estudiante.template.html'%}
{% load staticfiles %}
{% block title %}
    ESTUDIANTE
{% endblock title %}

{% block modal %}
    <!-- Modal -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content modal-docente-content ">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <div class="content-input-seguimiento">
                        <input type="text" name="seg_asignatura" readonly="readonly" name="seg_seguimiento" class="modal-title input-seg_asignatura" id="asignatura" >
                        <input type="text" name="seg_docente" readonly="readonly" name="seg_docente" class="input-seg_asignatura" id="docente" >
                    </div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-docente">
                        <div class="group-fila-cna">
                            <div class="group-campo campo-cedula">
                                <input type="text" name="seg_periodo" class="input-campo" id="periodo" style="display:none;">
                            </div>
                            <div class="group-campo campo-nombre-apellido">
                                <input type="text" name="seg_semestre" class="input-campo" id="semestre" style="display:none;">
                            </div>
                            <div class="group-campo campo-nombre-apellido">
                                <input type="text" name="seg_paralelo" class="input-campo" id="paralelo" style="display:none;">
                            </div>
                        </div>
                        <div class="group-fila-cna jc-center">
                            <div class="group-campo w-35 mr-20">
                                <label for="{{ form.seg_fecha.name }}" class="label-campo">{{ form.seg_fecha.label }}</label>
                                <div class="input-group date">
                                    {{ form.seg_fecha }}
                                </div>
                            </div>
                            <div class="group-campo w-20 ml-10">
                                <label for="{{ form.seg_porcentaje_real.name }}" class="label-campo">{{ form.seg_porcentaje_real.label }}</label>
                                <div class="seg_porcentaje-content">
                                    {{ form.seg_porcentaje_real }}
                                    <span class="porcentaje-icon">%</span>
                                </div>
                            </div>
                            <div class="group-campo w-20 ml-10">
                                <label for="{{ form.seg_porcentaje_ideal.name }}" class="label-campo">{{ form.seg_porcentaje_ideal.label }}</label>
                                <div class="seg_porcentaje-content">
                                    {{ form.seg_porcentaje_ideal }}
                                    <span class="porcentaje-icon">%</span>
                                </div>
                            </div>
                            <div class="group-campo w-10 mr-20">
                                <label for="{{ form.seg_semana.name }}" class="label-campo">{{ form.seg_semana.label }}</label>
                                {{ form.seg_semana }}
                            </div>
                            
                        </div>
                        <div class="campo-mensaje">
                            {{ form.seg_observaciones }}
                        </div>
                    </div> 
                </div>
                <div class="modal-footer">
                    <button class="btn-agregar" type="submit"><i class="icon-btn fas fa-save"></i>GUARDAR</button>
                    <button class="btn-cerrar"  data-dismiss="modal" id="btn-cerrar"><i class="icon-btn fas fa-times"></i>CANCELAR</button>
                </div>
            </form>
        </div>
        </div>
    </div>
{% endblock modal %}


{% block seguimiento-activo %}
    active-menu-item
{% endblock seguimiento-activo %}


{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="message-{{ message.tags }} alert alert-warning alert-dismissible fade show content-error" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endfor %}
{% endif %}
    <div class="content-docentes">
        <div class="content-seguimiento">
            <div class="informacion-periodo">
                <span id="label-periodo"><strong>PERIODO:</strong> <span>{{curso_list.periodo}}</span></span>
                <span id="label-semestre"><strong>SEMESTRE:</strong> <span>{{curso_list.semestre}}</span></span>
                <span id="label-paralelo"><strong>PERALELO:</strong> <span>{{curso_list.cur_paralelo}}</span></span>
            </div>
            <div class="accordion" id="accordionExample">
                {% for horario in horario_list %}
                    <div class="card w-100">
                        <div class="card-header bg-primary text-center" onclick="obtenerId(this);" id="heading{{ forloop.counter }}" data-toggle="collapse" data-target="#collapse{{ forloop.counter }}" aria-expanded="true" aria-controls="collapse{{ asignatura.forloop.counter }}">
                            <h5 class="mb-0 blanco asignatura-title">{{ horario.asignatura.asi_nombre }}</h5>
                            <h6 class="mb-0 blanco asignatura-docente">{{ horario.docente }}</h6>
                        </div>
                        <div id="collapse{{ forloop.counter }}" class="collapse" aria-labelledby="heading{{ asignatura.forloop.counter }}" data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="card-body-top">
                                    <div class="content-btn-agregar seguimiento-content-btn">
                                        <span class="btn-agregar seguimiento-btn-agregar" data-toggle="modal" data-target="#exampleModalCenter"><i class="icon-btn fas fa-plus" ></i>AGREGAR</span>
                                    </div>
                                    <div class="content-search">
                                        <input class="input-buscar datepicker" id="searchTerm-{{ forloop.counter }}" type="text" onfocus="doSearch();" onkeyup="doSearch();" placeholder="BUSCAR..."><i class="icon-buscar fas fa-search"></i>
                                    </div>
                                </div>
                                <div class="card-body-content">
                                    <table class="table table-bordered" id="datos-{{ forloop.counter }}">
                                        <thead>
                                            <tr>
                                            <th class="text-center" scope="col">NUM. <br> SEMANA</th>
                                            <th scope="col">FECHA</th>
                                            <th class="text-center" scope="col">PORCENTAJE <br> REAL</th>
                                            <th class="text-center" scope="col">PORCENTAJE <br> IDEAL</th>
                                            <th scope="col">OBSERVACIONES</th>
                                            <th class="text-center" scope="col">ACCIONES</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for seguimiento in seguimiento_list %}
                                                {% if seguimiento.asignatura.asi_nombre == horario.asignatura.asi_nombre %}
                                                    <tr>
                                                        <th class="text-center filtro-semana" scope="row">{{seguimiento.seg_semana}}</th>
                                                        <td class="filtro-fecha">{{seguimiento.seg_fecha |date:'d/m/Y' }}</td>
                                                        <td class="text-center suma-por-real"><span>{{seguimiento.seg_porcentaje_real}}</span> %</td>
                                                        <td class="text-center suma-por-ideal"><span>{{seguimiento.seg_porcentaje_ideal}}</span> %</td>
                                                        <td>{{seguimiento.seg_observaciones}}</td>
                                                        <td class="text-center">
                                                            <div class="content-acciones">
                                                                <a class="btn-acciones btn-acciones-eliminar" href="{% url 'estudiante:seguimientos_editar' seguimiento.id %}"><i class="fas fa-pencil-alt"></i></a>
                                                                <a class="btn-acciones btn-acciones-editar" href="{% url 'estudiante:seguimientos_eliminar' seguimiento.id %}"><i class="fas fa-trash-alt"></i></a>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                                                                           
                                            {% endfor %}
                                            <tr>
                                                <th class="text-center filtro-semana bg-primary blanco" colspan="2" scope="row">AVANCE PORCENTUAL</th>
                                                <td class="text-center total-real"><span></span> %</td>
                                                <td class="text-center total-ideal"><span></span> %</td>
                                                <td></td>
                                                <td class="text-center"></td>
                                            </tr>   
                                        </tbody>
                                    </table>
                                    
                                </div>
                                <div class="content-semana-filtro" style="display:none;">
                                        {% for seguimiento in seguimiento_list %}
                                            {% if seguimiento.asignatura.asi_nombre == horario.asignatura.asi_nombre %}
                                            <span>{{seguimiento.seg_semana}},</span>
                                            {% endif %}                                                    
                                        {% endfor %}
                                        </div>
                                <nav aria-label="..." class="content-pagination">
                                    SEMANA
                                    <ul class="pagination">
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>

        function crearPaginationItem(text){
            item = document.createElement('li');
            item.setAttribute('class', 'page-item item-semana');

            check = document.createElement('input');
            check.setAttribute('class', 'check-filtro');
            check.setAttribute('type', 'checkbox');
            check.setAttribute('id', text);
            
            label = document.createElement('label');
            label.setAttribute('class', 'label-filtro');
            //label.setAttribute('for', text);
            label.textContent = text
            

            item.appendChild(check);
            item.appendChild(label);
            return item
        }

        var btnAgregarList = document.getElementsByClassName('seguimiento-btn-agregar');
        var cardHeader = document.getElementsByClassName('card-header');
        var asignatura = document.getElementById('asignatura');
        var docente = document.getElementById('docente');
        var periodo = document.getElementById('periodo');
        var semestre = document.getElementById('semestre');
        var paralelo = document.getElementById('paralelo');
        var labelPeriodo = document.getElementById('label-periodo');
        var labelSemestre = document.getElementById('label-semestre');
        var labelParalelo = document.getElementById('label-paralelo');
        var pagination = document.getElementsByClassName('content-semana-filtro');
        var contentPagination = document.getElementsByClassName('pagination');
        
        var strPagination = "";
        var arrayPagination = [];

        for(let i=0; i < pagination.length; i++){
            strPagination = "";
            for(let j=0; j < pagination[i].children.length; j++){
                strPagination += pagination[i].children[j].textContent;
            }
            arrayPagination.push(Array.from(new Set(strPagination.split(','))));
        }

        for(let i=0; i < contentPagination.length; i++){
            for(let j=0; j < arrayPagination[i].length-1; j++){
                contentPagination[i].appendChild(crearPaginationItem(arrayPagination[i][j]));
            }
        }

        for(let i=0; i < btnAgregarList.length; i++){
            btnAgregarList[i].addEventListener("click", ()=>{
                asignatura.value = cardHeader[i].children[0].textContent;
                docente.value = cardHeader[i].children[1].textContent;
                periodo.value = labelPeriodo.children[1].textContent;
                semestre.value = labelSemestre.children[1].textContent;
                paralelo.value = labelParalelo.children[1].textContent;
                fechaSeguimiento.value = diaActual+"/"+mesActual+"/"+anioActual;
                var fechaSeguimientoAux = fechaSeguimiento.value.split('/');
                var dia = "";
                
                fechaSeguimientoDate = new Date(fechaSeguimientoAux[2]+"/"+fechaSeguimientoAux[1]+"/"+fechaSeguimientoAux[0]);
                
                dia = obtenerDiaString(fechaSeguimientoDate.getDay());

                for(let i=0;i<horario[asignatura.value].length;i++){
                    if(horario[asignatura.value][i][0] == dia){
                        porcentajeIdealInput.value = ((parseFloat(horario[asignatura.value][i][1]) * 100) / parseFloat(horario[asignatura.value][i][2])).toFixed(2)
                        break;
                    } else {
                        porcentajeIdealInput.value = "0";
                    }
                }
                segNumSemana.value = fechaSeguimientoDate.getWeekNumber() - new Date(periodoInicio).getWeekNumber() + 1;
                if (porcentajeIdealInput.value == "0"  || parseFloat(porcentajeRealInput.value) != parseFloat(porcentajeIdealInput.value)){
                    observacionesInput.setAttribute('required', 'true');
                } else {
                    observacionesInput.removeAttribute('required');
                }
            });
        }
    </script>
{% endblock content %}

{% block scripts-opcionales %}
<script src="{% static 'lib/bootstrap-datepicker/js/bootstrap-datepicker.min.js'%}"></script>
<script src="{% static 'lib/bootstrap-datepicker/locales/bootstrap-datepicker.es.min.js'%}"></script>
<script>
        var periodoInicio = "{{curso_list.periodo.per_inicio |date:'Y/m/d'}}";
        var periodoFin = "{{curso_list.periodo.per_fin |date:'Y/m/d'}}";
        var now = new Date();
        var start = new Date(periodoInicio);
        var end = new Date(periodoFin);
        var diff = now - start;
        var add = end - now;
        var oneDay = 1000 * 60 * 60 * 24;
        var day = Math.floor(diff / oneDay);
        var dayEnd = Math.floor(add / oneDay);
        var startdate = "-"+day+"d";
        var endDate = "+"+(dayEnd+1)+"d";
        $('.datepicker').datepicker({
            format: "dd/mm/yyyy",
            startDate: startdate,
            endDate: endDate,
            language: "es",
            daysOfWeekDisabled: "0,6",
            daysOfWeekHighlighted: "1,2,3,4,5",
            todayHighlight: true
        });
</script>
<script>
    var horario = {};
    var periodoInicio = "{{curso_list.periodo.per_inicio |date:'Y/m/d'}}";
    var periodoFin = "{{curso_list.periodo.per_fin |date:'Y/m/d'}}";

        {% for horario in horario_completo %}
            horario["{{horario.asignatura.asi_nombre}}"] = [];
        {% endfor %}
        {% for horario in horario_completo %}
            horario["{{horario.asignatura.asi_nombre}}"].push(["{{horario.hor_dia}}", "{{horario.hor_horas}}", "{{horario.asignatura.asi_num_creditos}}"]);
        {% endfor %}

    var fechaActual = new Date();
    var fechaSeguimiento = document.getElementById('fecha-seguimiento');
    var segNumSemana = document.getElementById('id-seg-semana');
    var porcentajeIdealInput = document.getElementById('id_seg_porcentaje_ideal');
    var porcentajeRealInput = document.getElementById('id_seg_porcentaje_real');
    var observacionesInput = document.getElementById('id-seg-observaciones');
    var busquedaInput = ""
    var busquedaTable = ""
    
    diaActual = fechaActual.getDate();
    mesActual = fechaActual.getMonth() + 1;
    anioActual = fechaActual.getFullYear();
    porcentajeRealInput.value = 0;

    obtenerId = function(obj){
        busquedaInput = obj.parentElement.children[1].children[0].children[0].children[1].children[0].getAttribute('id');
        busquedaTable = obj.parentElement.children[1].children[0].children[1].children[0].getAttribute('id');
        itemsPagination = obj.parentElement.children[1].children[0].children[3].children[0].children;
        
        avancePorcentual();

        document.getElementById(busquedaInput).addEventListener('click', ()=>{
            for(let k=0; k < itemsPagination.length; k++){
                itemsPagination[k].children[0].checked = false;
            }
        });
        
        for(let i=0; i < itemsPagination.length; i++){
            itemsPagination[i].addEventListener('click', ()=>{
                let textSearch = ""
                for(let k=0; k < itemsPagination.length; k++){
                    if(itemsPagination[k].children[0].checked == true){
                        textSearch += itemsPagination[k].children[1].textContent
                    }
                    doSearchSemana(textSearch);
                }
                avancePorcentual();
            });
        }
    }

    


    fechaSeguimiento.addEventListener('focus', ()=>{
        var fechaSeguimientoAux = fechaSeguimiento.value.split('/');
        var dia = "";
        
        fechaSeguimientoDate = new Date(fechaSeguimientoAux[2]+"/"+fechaSeguimientoAux[1]+"/"+fechaSeguimientoAux[0]);
        
        dia = obtenerDiaString(fechaSeguimientoDate.getDay());

        for(let i=0;i<horario[asignatura.value].length;i++){
            if(horario[asignatura.value][i][0] == dia){
                porcentajeIdealInput.value = ((parseFloat(horario[asignatura.value][i][1]) * 100) / parseFloat(horario[asignatura.value][i][2])).toFixed(2)
                break;
            } else {
                porcentajeIdealInput.value = "0";
            }
        }
        segNumSemana.value = fechaSeguimientoDate.getWeekNumber() - new Date(periodoInicio).getWeekNumber() + 1;

        

        if (porcentajeIdealInput.value == "0" || parseFloat(porcentajeRealInput.value) != parseFloat(porcentajeIdealInput.value)){
            observacionesInput.setAttribute('required', 'true');
        } else {
            observacionesInput.removeAttribute('required');
        }
    });
    
    fechaSeguimiento.addEventListener('blur', ()=>{
        if(fechaSeguimiento.value == ""){
            fechaSeguimiento.value = diaActual+"/"+mesActual+"/"+anioActual;
        }
        var fechaSeguimientoAux = fechaSeguimiento.value.split('/');
        var dia = "";
        
        fechaSeguimientoDate = new Date(fechaSeguimientoAux[2]+"/"+fechaSeguimientoAux[1]+"/"+fechaSeguimientoAux[0]);
        
        dia = obtenerDiaString(fechaSeguimientoDate.getDay());

        for(let i=0;i<horario[asignatura.value].length;i++){
            if(horario[asignatura.value][i][0] == dia){
                porcentajeIdealInput.value = ((parseFloat(horario[asignatura.value][i][1]) * 100) / parseFloat(horario[asignatura.value][i][2])).toFixed(2)
                break;
            } else {
                porcentajeIdealInput.value = "0"
            }
        }
        segNumSemana.value = fechaSeguimientoDate.getWeekNumber() - new Date(periodoInicio).getWeekNumber() + 1;

        console.log(porcentajeRealInput.value)

        if (porcentajeIdealInput.value == "0"  || parseFloat(porcentajeRealInput.value) != parseFloat(porcentajeIdealInput.value)){
            observacionesInput.setAttribute('required', 'true');
        } else {
            observacionesInput.removeAttribute('required');
        }
    });

    porcentajeRealInput.addEventListener('change', ()=>{
        if(porcentajeRealInput.value == ""){
            porcentajeRealInput.value = 0;
        }
    });

    porcentajeRealInput.addEventListener('keyup', ()=>{

        if (parseFloat(porcentajeRealInput.value) != parseFloat(porcentajeIdealInput.value)){
            observacionesInput.setAttribute('required', 'true');
        } else {
            observacionesInput.removeAttribute('required');
        }
    });
    
    function obtenerDiaString(diaNumber){
        var dia = "";
        switch(diaNumber){
            case 1:
                dia = "LUNES";
                break;
            case 2:
                dia = "MARTES";
                break;
            case 3:
                dia = "MIERCOLES";
                break;
            case 4:
                dia = "JUEVES";
                break;
            case 5:
                dia = "VIERNES";
                break;
        }
        return dia;
    }

    Date.prototype.getWeekNumber = function () {
        var d = new Date(+this);
        d.setHours(0, 0, 0, 0); 
        d.setDate(d.getDate() + 4 - (d.getDay() || 7)); 
        return Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 8.64e7) + 1) / 7);
    };

</script>
<script>

        function doSearchSemana(semanaText)
        {
            var tableReg = document.getElementById(busquedaTable);
            var searchDate = semanaText;
            var cellsOfRow="";
            var found=false;
            var compareWith="";
            
 
            // Recorremos todas las filas con contenido de la tabla
            for (var i = 1; i < tableReg.rows.length-1; i++)
            {
                cellsOfRow = tableReg.rows[i].getElementsByClassName('filtro-semana');
                found = false;
                // Recorremos todas las celdas
                for (var j = 0; j < cellsOfRow.length && !found; j++)
                {
                    compareWith = cellsOfRow[j].innerHTML;
                    // Buscamos el texto en el contenido de la celda
                    if (searchDate == "" || (searchDate.indexOf(compareWith) > -1))
                    {
                        found = true;
                    }
                }
                if(found)
                {
                    tableReg.rows[i].style.display = '';
                } else {
                    // si no ha encontrado ninguna coincidencia, esconde la
                    // fila de la tabla
                    tableReg.rows[i].style.display = 'none';
                }
            }
        }

        function doSearch()
        {
            var tableReg = document.getElementById(busquedaTable);
            var searchDate = document.getElementById(busquedaInput).value;
            //var searchSemana = document.getElementById(busquedaInput);
            var cellsOfRow="";
            var found=false;
            var compareWith="";
            
 
            // Recorremos todas las filas con contenido de la tabla
            for (var i = 1; i < tableReg.rows.length-1; i++)
            {
                cellsOfRow = tableReg.rows[i].getElementsByClassName('filtro-fecha');
                found = false;
                // Recorremos todas las celdas
                for (var j = 0; j < cellsOfRow.length && !found; j++)
                {
                    compareWith = cellsOfRow[j].innerHTML;
                    // Buscamos el texto en el contenido de la celda
                    if (searchDate.length == 0 || (compareWith.indexOf(searchDate) > -1))
                    {
                        found = true;
                    }
                }
                if(found)
                {
                    tableReg.rows[i].style.display = '';
                } else {
                    // si no ha encontrado ninguna coincidencia, esconde la
                    // fila de la tabla
                    tableReg.rows[i].style.display = 'none';
                }
            }
        }

        function avancePorcentual(){
            var table = document.getElementById(busquedaTable);
            var sumPorReal = 0.00;
            var sumPorIdeal = 0.00;
            for(let i=0;i<table.rows.length-1;i++){
                if(table.rows[i].style.display != "none"){
                    cellPorReal = table.rows[i].getElementsByClassName('suma-por-real');
                    cellPorIdeal = table.rows[i].getElementsByClassName('suma-por-ideal');
                    for(let k=0;k<cellPorReal.length;k++){
                        decimal = cellPorReal[k].children[0].textContent.split(",");
                        cell = decimal[0] +"."+ decimal[1];
                        sumPorReal += parseFloat(cell);
                        decimal = cellPorIdeal[k].children[0].textContent.split(",");
                        cell = decimal[0] +"."+ decimal[1];
                        sumPorIdeal += parseFloat(cell);
                    }
                }
            }
            table.rows[table.rows.length-1].getElementsByClassName('total-real')[0].children[0].textContent = Math.ceil(sumPorReal)
            table.rows[table.rows.length-1].getElementsByClassName('total-ideal')[0].children[0].textContent = Math.ceil(sumPorIdeal)
        }
    </script>
{% endblock scripts-opcionales %}